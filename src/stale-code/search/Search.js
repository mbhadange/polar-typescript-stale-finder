"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.main = exports.getExtension = exports.printMap = exports.swapMapValues = exports.sortMap = exports.expandPath = exports.checkFullPath = exports.updateHitMap = exports.initializeTypescriptMapFiles = void 0;
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const find_1 = require("./find");
const find_2 = require("./find");
function initializeTypescriptMapFiles(data, currMap) {
    for (var k = 0; k < data.length; k++) {
        if (currMap.has(data[k].path) == false) {
            if (data[k].name.includes('test.ts') || data[k].name.includes('.d.ts')) {
                continue;
            }
            else if (data[k].name.split('.').pop() === 'ts' || data[k].name.split('.').pop() === 'tsx') {
                currMap.set(data[k].path, 0);
            }
        }
    }
}
exports.initializeTypescriptMapFiles = initializeTypescriptMapFiles;
function updateHitMap(currFullPath, currMap) {
    if (currFullPath != undefined) {
        if (currMap.has(currFullPath) === true) {
            var currVal = currMap.get(currFullPath);
            if (currVal != undefined) {
                currMap.set(currFullPath, currVal + 1);
            }
        }
        else {
            currMap.set(currFullPath, 1);
        }
    }
}
exports.updateHitMap = updateHitMap;
function checkFullPath(finalPath) {
    if (fs.existsSync(finalPath) == false) {
        finalPath = finalPath + 'x';
        if (fs.existsSync(finalPath) == false) {
            finalPath = finalPath.replace(finalPath.substring(finalPath.length - 3), "");
            finalPath = finalPath + 'd.ts';
            if (finalPath.includes('utils.js.d.ts')) {
                finalPath = finalPath.replace(finalPath.substring(finalPath.length - 7), "");
                finalPath = finalPath + 'ts';
            }
            if (fs.existsSync(finalPath) == false) {
                console.warn("File does not exist: " + finalPath);
            }
        }
    }
    return finalPath;
}
exports.checkFullPath = checkFullPath;
function expandPath(currPath) {
    currPath = currPath.replace(/['"]+/g, '');
    if (currPath.includes('.ts') == false) {
        currPath = currPath.replace(currPath.substring(currPath.length - 1), "");
        currPath = currPath + '.ts';
    }
    return currPath;
}
exports.expandPath = expandPath;
function sortMap(currMap) {
    currMap[Symbol.iterator] = function* () {
        yield* [...this.entries()].sort((a, b) => a[1] - b[1]);
    };
    return currMap;
}
exports.sortMap = sortMap;
function swapMapValues(currMap) {
    var finalHitMap = [];
    for (var index = 0; index < currMap.length; index++) {
        var currentArray = currMap[index];
        var key = currentArray[0];
        var value = currentArray[1];
        finalHitMap[index] = [value, key];
    }
    return finalHitMap;
}
exports.swapMapValues = swapMapValues;
function printMap(finalMap) {
    for (var j = 0; j < finalMap.length; j++) {
        var curr = finalMap[j];
        if (curr[1].includes('Test') == false && curr[1].includes('test') == false) {
            console.log(curr[0], ' ', curr[1]);
        }
    }
}
exports.printMap = printMap;
function getExtension(filename) {
    var extension = filename.split('.').pop();
    if (extension != undefined) {
        return extension;
    }
    else {
        return 'undefined';
    }
}
exports.getExtension = getExtension;
function main() {
    var argument = process.argv;
    var hitMap = new Map();
    for (var x = 2; x < argument.length; x++) {
        const opts = new find_2.DefaultOpts();
        var myArgs = argument[x];
        var fileMap = find_1.Search.findFilesRecursively(myArgs, opts);
        initializeTypescriptMapFiles(fileMap, hitMap);
        for (var i = 0; i < fileMap.length; i++) {
            var file = fileMap[i];
            var initialFileName = file.name;
            var initialFilePath = file.path;
            var ext = getExtension(initialFileName);
            if (file.name.includes('test.ts') || file.name.includes('.d.ts')) {
                continue;
            }
            else if (['ts', 'tsx'].includes(ext)) {
                const data = fs.readFileSync(initialFilePath, 'utf8');
                const lines = data.split(/\r?\n/);
                const re = /import(?:["'\s]*([\w*{}\n\r\t, ]+)from\s*)?["'\s].*([@\w_-]+)["'\s].*;$/;
                lines.forEach((line) => {
                    var importLine = line.match(re);
                    if (importLine != null) {
                        var importVal = importLine[0];
                        var filePath = importVal.split(' ').pop();
                        var fullPath;
                        if (filePath != undefined) {
                            if (filePath.includes('./') || filePath.includes('../')) {
                                filePath = expandPath(filePath);
                                var fullDirectory = path.dirname(initialFilePath);
                                fullPath = path.resolve(fullDirectory, filePath);
                                fullPath = checkFullPath(fullPath);
                            }
                        }
                        if (fullPath != undefined) {
                            updateHitMap(fullPath, hitMap);
                        }
                    }
                });
            }
        }
    }
    hitMap = sortMap(hitMap);
    var updatedHitMap = [...hitMap];
    var finalMap = swapMapValues(updatedHitMap);
    printMap(finalMap);
}
exports.main = main;
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VhcmNoLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU2VhcmNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBQzdCLGlDQUFxQztBQUNyQyxpQ0FBbUM7QUFPbkMsU0FBZ0IsNEJBQTRCLENBQUUsSUFBMkIsRUFBRSxPQUE0QjtJQUNuRyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNsQyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssRUFBRTtZQUNwQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNyRSxTQUFTO2FBQ1o7aUJBRUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssS0FBSyxFQUFFO2dCQUV4RixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDaEM7U0FDSjtLQUNKO0FBQ0wsQ0FBQztBQWJELG9FQWFDO0FBT0QsU0FBZ0IsWUFBWSxDQUFFLFlBQXFCLEVBQUUsT0FBNEI7SUFDN0UsSUFBSSxZQUFZLElBQUksU0FBUyxFQUFFO1FBRTNCLElBQUksT0FBTyxD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QUksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEVycm5vRXhjZXB0aW9uID0gTm9kZUpTLkVycm5vRXhjZXB0aW9uO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHtTZWFyY2gsIElGaWxlfSBmcm9tIFwiLi9maW5kXCI7XG5pbXBvcnQge0RlZmF1bHRPcHRzfSBmcm9tIFwiLi9maW5kXCI7XG5cbi8qKlxuICogaXRlcmF0ZXMgdGhyb3VnaCBlYWNoIGZpbGUgaW4gdGhlIGRpcmVjdG9yeSBhbmQgYWRkcyB0byB0aGUgbWFwXG4gKiBAcGFyYW0gZGF0YSBcbiAqIEBwYXJhbSBjdXJyTWFwIFxuICovXG5leHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZVR5cGVzY3JpcHRNYXBGaWxlcyAoZGF0YSA6IFJlYWRvbmx5QXJyYXk8SUZpbGU+LCBjdXJyTWFwIDogTWFwPHN0cmluZyxudW1iZXI+KSB7XG4gICAgZm9yICh2YXIgayA9IDA7IGsgPCBkYXRhLmxlbmd0aDsgaysrKSB7XG4gICAgICAgIGlmIChjdXJyTWFwLmhhcyhkYXRhW2tdLnBhdGgpID09IGZhbHNlKSB7XG4gICAgICAgICAgICBpZiAoZGF0YVtrXS5uYW1lLmluY2x1ZGVzKCd0ZXN0LnRzJykgIHx8IGRhdGFba10ubmFtZS5pbmNsdWRlcygnLmQudHMnKSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8vIGNoZWNrcyB0byBtYWtlIHN1cmUgdGhhdCB0aGUgZmlsZSB0eXBlIGlzIGVpdGhlciAudHMgb3IgLnRzeFxuICAgICAgICAgICAgZWxzZSBpZiAoZGF0YVtrXS5uYW1lLnNwbGl0KCcuJykucG9wKCkgPT09ICd0cycgfHwgZGF0YVtrXS5uYW1lLnNwbGl0KCcuJykucG9wKCkgPT09ICd0c3gnKSB7XG4gICAgICAgICAgICAgICAgLy8vIGluaXRpYWxpemVzIGhpdE1hcFxuICAgICAgICAgICAgICAgIGN1cnJNYXAuc2V0KGRhdGFba10ucGF0aCwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gXG4gICAgfVxufVxuXG4vKipcbiAqIHVwZGF0ZXMgdGhlIHZhbHVlIG9mIHRoZSBmaWxlIGluIHRoZSBoaXRNYXBcbiAqIEBwYXJhbSBjdXJyRnVsbFBhdGggXG4gKiBAcGFyYW0gY3Vyck1hcCBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZUhpdE1hcCAoY3VyckZ1bGxQYXRoIDogc3RyaW5nLCBjdXJyTWFwIDogTWFwPHN0cmluZyxudW1iZXI+KSB7XG4gICAgaWYgKGN1cnJGdWxsUGF0aCAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8vIGNoZWNrcyB0byBzZWUgaWYgdGhlIGhpdG1hcCBhbHJlYWR5IGhhcyB0aGF0IHBhdGhcbiAgICAgICAgaWYgKGN1cnJNYXAuaGFzKGN1cnJGdWxsUGF0aCkgPT09IHRydWUpIHtcbiAgICAgICAgICAgIC8vLyBpZiBpdCBkb2VzIHRoZW4gaW5jcmVtZW50cyB0aGUgdmFsdWUgb2YgdGhhdCBmaWxlIGJ5IDFcbiAgICAgICAgICAgIHZhciBjdXJyVmFsID0gY3Vyck1hcC5nZXQoY3VyckZ1bGxQYXRoKTtcbiAgICAgICAgICAgIGlmIChjdXJyVmFsICE9IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGN1cnJNYXAuc2V0KGN1cnJGdWxsUGF0aCwgY3VyclZhbCArIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vLyBpZiB0aGUgaGl0bWFwIGRvZXMgbm90IGhhdmUgdGhhdCBwYXRoIGFzIGEga2V5IGFscmVhZHlcbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLy8gdGhlbiBzZXRzIHRoYXQgZmlsZSBwYXRoIHRvIGhhdmUgYSB2YWx1ZSBvZiAxXG4gICAgICAgICAgICBjdXJyTWFwLnNldChjdXJyRnVsbFBhdGgsIDEpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIGNoZWNrcyB0byBtYWtlIHN1cmUgdGhhdCB0aGUgcGF0aCBleGlzdHMgICAgICAgICAgICAgICAgICAgICAgICAgXG4gKiBAcGFyYW0gZmluYWxQYXRoIFxuICovXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tGdWxsUGF0aCAoZmluYWxQYXRoIDogc3RyaW5nKSA6IHN0cmluZyB7XG4gICAgaWYgKGZzLmV4aXN0c1N5bmMoZmluYWxQYXRoKSA9PSBmYWxzZSkge1xuICAgICAgICBmaW5hbFBhdGggPSBmaW5hbFBhdGggKyAneCc7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbmFsUGF0aCkgPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGZpbmFsUGF0aCA9IGZpbmFsUGF0aC5yZXBsYWNlKGZpbmFsUGF0aC5zdWJzdHJpbmcoZmluYWxQYXRoLmxlbmd0aC0zKSwgXCJcIik7XG4gICAgICAgICAgICBmaW5hbFBhdGggPSBmaW5hbFBhdGggKyAnZC50cyc7XG4gICAgICAgICAgICBpZiAoZmluYWxQYXRoLmluY2x1ZGVzKCd1dGlscy5qcy5kLnRzJykpIHtcbiAgICAgICAgICAgICAgICBmaW5hbFBhdGggPSBmaW5hbFBhdGgucmVwbGFjZShmaW5hbFBhdGguc3Vic3RyaW5nKGZpbmFsUGF0aC5sZW5ndGgtNyksIFwiXCIpO1xuICAgICAgICAgICAgICAgIGZpbmFsUGF0aCA9IGZpbmFsUGF0aCArICd0cyc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaW5hbFBhdGgpID09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiRmlsZSBkb2VzIG5vdCBleGlzdDogXCIgKyBmaW5hbFBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmaW5hbFBhdGg7XG59XG5cbi8qKlxuICogY29udmVydHMgdGhhdCBmaWxlIHBhdGggaW50byBhIGZ1bGwgZmlsZSBwYXRoXG4gKiBAcGFyYW0gY3VyclBhdGggXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBleHBhbmRQYXRoIChjdXJyUGF0aCA6IHN0cmluZykgOiBzdHJpbmcge1xuICAgIC8vLyBmaXhlcyB0aGUgcHVuY3R1YXRpb24gb2YgdGhlIGZpbGUgcGF0aCBvZiB0aGUgaW1wb3J0XG4gICAgY3VyclBhdGggPSBjdXJyUGF0aC5yZXBsYWNlKC9bJ1wiXSsvZywgJycpO1xuICAgIGlmIChjdXJyUGF0aC5pbmNsdWRlcygnLnRzJykgPT0gZmFsc2UpIHtcbiAgICAgICAgY3VyclBhdGggPSBjdXJyUGF0aC5yZXBsYWNlKGN1cnJQYXRoLnN1YnN0cmluZyhjdXJyUGF0aC5sZW5ndGgtMSksIFwiXCIpO1xuICAgICAgICBjdXJyUGF0aCA9IGN1cnJQYXRoICsgJy50cyc7XG4gICAgfVxuICAgIHJldHVybiBjdXJyUGF0aDtcbn1cblxuLyoqXG4gKiBTb3J0cyB0aGUgbWFwIGluIG9yZGVyIGJhc2VkIG9uIHRoZSBoaXQgdmFsdWVzIFxuICogQHBhcmFtIGN1cnJNYXAgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzb3J0TWFwKGN1cnJNYXAgOiBNYXA8c3RyaW5nLG51bWJlcj4pIDogTWFwPHN0cmluZyxudW1iZXI+IHtcbiAgICBjdXJyTWFwW1N5bWJvbC5pdGVyYXRvcl0gPSBmdW5jdGlvbiogKCkge1xuICAgICAgICB5aWVsZCogWy4uLnRoaXMuZW50cmllcygpXS5zb3J0KChhLCBiKSA9PiBhWzFdIC0gYlsxXSk7XG4gICAgfVxuICAgIHJldHVybiBjdXJyTWFwO1xufVxuXG4vKipcbiAqIHN3YXBzIHRoZSBrZXkgYW5kIHRoZSB2YWx1ZSBvZiB0aGUgbWFwLCBzbyB0aGUgbnVtYmVyIG9mIGhpdHMgaXMgZm9ybWF0dGVkIHRvIHRoZSBsZWZ0IG9mIHRoZSBmdWxsIGZpbGUgcGF0aFxuICogQHBhcmFtIGN1cnJNYXAgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzd2FwTWFwVmFsdWVzKGN1cnJNYXAgOiBhbnlbXVtdKSA6IGFueVtdW10ge1xuICAgIHZhciBmaW5hbEhpdE1hcCA9IFtdO1xuICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBjdXJyTWFwLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICB2YXIgY3VycmVudEFycmF5ID0gY3Vyck1hcFtpbmRleF07XG4gICAgICAgIHZhciBrZXkgPSBjdXJyZW50QXJyYXlbMF07XG4gICAgICAgIHZhciB2YWx1ZSA9IGN1cnJlbnRBcnJheVsxXTtcbiAgICAgICAgZmluYWxIaXRNYXBbaW5kZXhdID0gW3ZhbHVlLCBrZXldO1xuICAgIH1cbiAgICByZXR1cm4gZmluYWxIaXRNYXA7XG59XG5cbi8qKlxuICogcHJpbnRzIG91dCB0aGUgZmluYWwgTWFwXG4gKiBAcGFyYW0gZmluYWxNYXAgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwcmludE1hcChmaW5hbE1hcCA6IGFueVtdW10pIHtcbiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpbmFsTWFwLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIHZhciBjdXJyID0gZmluYWxNYXBbal07XG4gICAgICAgIGlmIChjdXJyWzFdLmluY2x1ZGVzKCdUZXN0JykgPT0gZmFsc2UgJiYgY3VyclsxXS5pbmNsdWRlcygndGVzdCcpID09IGZhbHNlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjdXJyWzBdLCAnICcsIGN1cnJbMV0pO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKipcbiAqIGdldHMgdGhlIGV4dGVuc2lvbiBvZiB0aGUgZmlsZW5hbWVcbiAqIEBwYXJhbSBmaWxlbmFtZSBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEV4dGVuc2lvbiAoZmlsZW5hbWUgOiBzdHJpbmcpIDogc3RyaW5nIHtcbiAgICB2YXIgZXh0ZW5zaW9uID0gZmlsZW5hbWUuc3BsaXQoJy4nKS5wb3AoKTtcbiAgICBpZiAoZXh0ZW5zaW9uICE9IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gZXh0ZW5zaW9uO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuICd1bmRlZmluZWQnO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1haW4oKSB7XG4gICAgLy8vIHVzZXMgcHJvY2Vzcy5hcmd2IHRvIHNlZSB0YWtlIGluIGFueSBudW1iZXIgb2YgZGlyZWN0b3JpZXMgaW4gdGhlIGNvbW1hbmQgbGluZVxuICAgIC8vLyBleGFtcGxlOiBub2RlIFNlYXJjaC5qcyAvVXNlcnMvbWloaXJtYWNwcm8xMy9Eb2N1bWVudHMvR2l0SHViL3BvbGFyLWJvb2tzaGVsZi93ZWIvanMgL1VzZXJzL21paGlybWFjcHJvMTMvRG9jdW1lbnRzL0dpdEh1Yi9wb2xhci1ib29rc2hlbGYvYXBwc1xuICAgIHZhciBhcmd1bWVudCA9IHByb2Nlc3MuYXJndjtcbiAgICAvLy8gY3JlYXRlcyBhbiBlbXB0eSBtYXBcbiAgICB2YXIgaGl0TWFwID0gbmV3IE1hcCgpO1xuICAgIGZvciAodmFyIHggPSAyOyB4IDwgYXJndW1lbnQubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IG5ldyBEZWZhdWx0T3B0cygpO1xuICAgICAgICB2YXIgbXlBcmdzID0gYXJndW1lbnRbeF07XG4gICAgICAgIC8vLyByZXR1cm5zIGFuIGFycmF5IHdpdGggYWxsIHRoZSBmaWxlcyBpbiB0aGUgZGlyZWN0b3J5XG4gICAgICAgIHZhciBmaWxlTWFwID0gU2VhcmNoLmZpbmRGaWxlc1JlY3Vyc2l2ZWx5KG15QXJncywgb3B0cyk7XG4gICAgICAgIC8vLyBpdGVyYXRlcyB0aHJvdWdoIGVhY2ggZmlsZSBpbiB0aGUgZGlyZWN0b3J5IGFuZCBhZGRzIHRvIHRoZSBtYXBcbiAgICAgICAgaW5pdGlhbGl6ZVR5cGVzY3JpcHRNYXBGaWxlcyhmaWxlTWFwLCBoaXRNYXApO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlsZU1hcC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgLy8vIG1hcCBvZiB0aGUgZmlsZSB0eXBlLCBuYW1lLCBwYXRoIFxuICAgICAgICAgICAgdmFyIGZpbGUgPSBmaWxlTWFwW2ldO1xuICAgICAgICAgICAgdmFyIGluaXRpYWxGaWxlTmFtZSA9IGZpbGUubmFtZTtcbiAgICAgICAgICAgIHZhciBpbml0aWFsRmlsZVBhdGggPSBmaWxlLnBhdGg7XG4gICAgICAgICAgICB2YXIgZXh0ID0gZ2V0RXh0ZW5zaW9uKGluaXRpYWxGaWxlTmFtZSk7XG5cbiAgICAgICAgICAgIC8vLyBjaGVja3MgdG8gc2VlIGlmIHRoZSBmaWxlIG5hbWUgaXMgdGVzdC50c1xuICAgICAgICAgICAgLy8vIGlmIGl0IGlzIHRoZW4gY29udGludWVzIHRvIHRoZSBuZXh0IGZpbGVcbiAgICAgICAgICAgIGlmIChmaWxlLm5hbWUuaW5jbHVkZXMoJ3Rlc3QudHMnKSAgfHwgZmlsZS5uYW1lLmluY2x1ZGVzKCcuZC50cycpKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLy8gY2hlY2tzIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSBmaWxlIHR5cGUgaXMgZWl0aGVyIC50cyBvciAudHN4XG4gICAgICAgICAgICBlbHNlIGlmIChbJ3RzJywndHN4J10uaW5jbHVkZXMoZXh0KSkge1xuICAgICAgICAgICAgICAgIC8vLyBnZXRzIGFsbCB0aGUgY29udGVudHMgb2YgdGhlIGN1cnJlbnQgZmlsZVxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMoaW5pdGlhbEZpbGVQYXRoLCd1dGY4Jyk7XG4gICAgICAgICAgICAgICAgLy8vIHNwbGl0cyBlYWNoIGxpbmUgb2YgZGF0YSB0byBhbGxvdyB1cyB0byBwYXJzZSB0aHJvdWdoIGVhY2ggb25lXG4gICAgICAgICAgICAgICAgY29uc3QgbGluZXMgPSBkYXRhLnNwbGl0KC9cXHI/XFxuLyk7XG4gICAgICAgICAgICAgICAgLy8vIGNyZWF0ZXMgYSByZWd1bGFyIGV4cHJlc3Npb24gZm9yIHRoZSBpbXBvcnQgbGluZXNcbiAgICAgICAgICAgICAgICBjb25zdCByZSA9IC9pbXBvcnQoPzpbXCInXFxzXSooW1xcdyp7fVxcblxcclxcdCwgXSspZnJvbVxccyopP1tcIidcXHNdLiooW0BcXHdfLV0rKVtcIidcXHNdLio7JC87XG4gICAgICAgICAgICAgICAgLy8vIGl0ZXJhdGVzIHRocm91Z2ggZWFjaCBsaW5lIG9mIHRoZSBmaWxlXG4gICAgICAgICAgICAgICAgbGluZXMuZm9yRWFjaCgobGluZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLy8gY2hlY2tzIHRvIHNlZSBpZiB0aGUgbGluZSBtYXRjaGVzIHRoZSBmb3JtYXQgb2YgdGhlIHJlZ3VsYXIgZXhwcmVzc2lvblxuICAgICAgICAgICAgICAgICAgICB2YXIgaW1wb3J0TGluZSA9IGxpbmUubWF0Y2gocmUpO1xuICAgICAgICAgICAgICAgICAgICAvLy8gbWFrZXMgc3VyZSB0aGF0IHRoZSBsaW5lIGFjdHVhbGx5IGhhcyB0aGUgcHJvcGVyIGZvcm1hdCBvZiB0aGUgcmVnRXhcbiAgICAgICAgICAgICAgICAgICAgaWYgKGltcG9ydExpbmUgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8vIGdldHMgdGhlIGVudGlyZSBpbXBvcnQgbGluZXMgY29udGVudHNcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbXBvcnRWYWwgPSBpbXBvcnRMaW5lWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8vIHNwbGl0cyB0aGUgbGluZSBiYXNlZCBvZmYgc3BhY2VzIGFuZCBnZXRzIG9ubHkgdGhlIGZpbGUgcGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpbGVQYXRoID0gaW1wb3J0VmFsLnNwbGl0KCcgJykucG9wKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZnVsbFBhdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLy8gY29udmVydHMgdGhhdCBmaWxlIHBhdGggaW50byBhIGZ1bGwgZmlsZSBwYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVBhdGggIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGVQYXRoLmluY2x1ZGVzKCcuLycpIHx8IGZpbGVQYXRoLmluY2x1ZGVzKCcuLi8nKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlUGF0aCA9IGV4cGFuZFBhdGgoZmlsZVBhdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLy8gY3JlYXRlcyB0aGUgZnVsbCBwYXRoIHdpdGggdGhlIHByb3BlciBkaXJlY3RvcnkgbmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZnVsbERpcmVjdG9yeSA9IHBhdGguZGlybmFtZShpbml0aWFsRmlsZVBhdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZShmdWxsRGlyZWN0b3J5LCBmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxQYXRoID0gY2hlY2tGdWxsUGF0aChmdWxsUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZ1bGxQYXRoICE9IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vLyB1cGRhdGVzIHRoZSB2YWx1ZSBvZiB0aGUgZmlsZSBpbiB0aGUgaGl0TWFwXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlSGl0TWFwKGZ1bGxQYXRoLCBoaXRNYXApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8vIHNvcnRzIHRoZSBtYXAgYmFzZWQgb24gdmFsdWVzXG4gICAgaGl0TWFwID0gc29ydE1hcChoaXRNYXApO1xuICAgIC8vLyBtYWtlcyB0aGUgbWFwIGludG8gYSB0YWJsZSB0eXBlIGZvcm1hdCB3aXRoIGEgbmVzdGVkIGFycmF5XG4gICAgdmFyIHVwZGF0ZWRIaXRNYXAgPSBbLi4uaGl0TWFwXTtcbiAgICAvLy8gc3dhcHMgdGhlIGtleSBhbmQgdmFsdWVcbiAgICB2YXIgZmluYWxNYXAgPSBzd2FwTWFwVmFsdWVzKHVwZGF0ZWRIaXRNYXApO1xuICAgIC8vLyBwcmludHMgdGhlIG1hcCBvdXQgaW4gdGFibGUgZm9ybWF0IChmb3JtYXQ6IGhpdFZhbHVlIC4uLiBbdGFiXSAuLi4gUGF0aClcbiAgICBwcmludE1hcChmaW5hbE1hcCk7XG59XG5cbi8vLyBydW5zIHRoZSBtYWluIGZ1bmN0aW9uIGFuZCBwcmludHMgb3V0IHRoZSB0YWJsZSB3aXRoIHRoZSBudW1iZXIgb2YgaGl0cyBhcyB0aGUga2V5IGFuZCB0aGUgcGF0aCBhcyB0aGUgdmFsdWVcbm1haW4oKTsgIl19